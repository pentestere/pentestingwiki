# This script cleans up the unsorted or mis-sorted files.
# It sorts the files based on the parent header in the markdown file.
import os
import re
import shutil

# Move the file to correct directory

def movefile(newdir, filename, newfile):
    if os.path.exists(newfile):
        print("File already exists, doing nothing...")
    else:
        shutil.move(filename, newfile)
        print("File has been moved to here: " + newfile)

# If directory is not found, create it

def createdir(newdir, filename, newfile):
    print("Creating directory: " + newdir)
    try:
        print(newdir)
        os.mkdir(newdir)
    except OSError:
        print("Failed to create directory %s" % newdir)
    else:
        print("Successfully created directory %s" % newdir)
        movefile(newdir, filename, newfile)

# Check if directory for header in file exists

def checkdir(directory, filename):
    f = open(filename)
    lines = f.read()
    lines = lines.split("parent:",1)[1]
    result = re.search('/(\w+)/', lines) # Regular expression to extract folder name from parent header
    if result != None: # Header found check if folder exists
         newdir = directory + result.group(1)
         folder = os.path.exists(newdir)
         newfile = newdir + re.search('/\w+.md',filename).group(0) # Regular expression to extract the filename
         if folder == True: # Folder exists, move file to folder
            movefile(newdir, filename, newfile)
         else: # Folder does not exist, create it
            createdir(newdir, filename, newfile)
# Check file for parent header

def checkfiles(directory, filename):
    if filename.endswith(".md"):
        f = open(filename)
        lines = f.read()
        if "parent:" in lines:
            checkdir(directory, filename)
        else:
            print('This file does not contain a parent header, doing nothing...')
        f.close()

# Find the base directory

directory = '/wiki/'
basedir = os.getcwd()

while basedir != '/':
    if 'wiki' in os.listdir(basedir):
        break
    else:
        basedir = basedir + '/../'

directory = basedir + directory

listoffiles = list()

# Building list of files

for (dirpath, dirnames, filenames) in os.walk(directory):
    listoffiles += [os.path.join(dirpath, file) for file in filenames]

# Looping through the files and extracting parent header.
# If header is found, file is moved to the folder matching the header.

for filename in listoffiles:
    checkfiles(directory, filename)



    
